---
title: "Run Analysis for A crop-type-here Experiment"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
    number_sections: true
---

# Preparation

## Set up

```{r setup, cache = F, echo = F}
library(knitr)
knitr::opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  error = TRUE,
  warning = FALSE,
  fig.retina = 6,
  message = FALSE
)

options(knitr.duplicate.label = "allow")

#--- working field-year ---#
ffy <- "field-year-here" 

#--- root directory ---#
opts_knit$set(root.dir = here("Data", "Growers", ffy))

```

## Packages

```{r pacakges, cache = FALSE}
# === packages ===#
library(sf)
library(tmap)
library(mgcv)
library(ggcorrplot)
library(patchwork)
library(scam)
library(parallel)
library(dplyr)
library(tidyverse)
library(corrplot)
library(data.table)
library(GWmodel)
library(mgcv)

```

```{r map-layout, cache = TRUE}
tm_layout_to_add <- tm_layout(
  legend.outside = "TRUE",
  frame = FALSE,
  legend.title.size = 2,
  legend.text.size = 1.5
)

```

## Field parameters

```{r echo = F, results = "hide"}
#--- define field parameters ---#
# source(here("Codes/Functions/unpack_field_parameters.R"))
source(
  get_r_file_name("Functions/unpack_field_parameters.R"), 
  local = TRUE
)

#--- source functions ---#
source(
  "https://github.com/tmieno2/DIFM/blob/master/Functions/prepare.R?raw=TRUE",
  local = TRUE
)

```

# Title-here analysis

## Read the analysis data 

```{r data-prep-s, cache = F, results = "hide"}

data_sf <- here("Data/Growers", ffy, "Analysis-Ready/analysis_data.rds") %>% 
  readRDS() %>% 
  rename(yield = yield_vol) %>% 
  filter(!is.na(yield)) %>% 
  cbind(., st_coordinates(st_centroid(.))) 

```

## GWR estimation for management zone delineation

### GWR estimation

```{r gwr, results = "hide"}

analysis_res <- trial_info %>% 
  mutate(data = rep(list(data_sf), nrow(.))) %>% 
  rowwise() %>% 
  mutate(
    data = list(
      setnames(
        data.table::copy(data),
        paste0(tolower(input_type), "_rate"),
        "input_rate"
      )
    )
  ) %>%  
  mutate(
    data = list(
      run_gwr(data, "input_rate") 
    )
  ) 

```

### GWR estimates histogram

```{r }
pluck(analysis_res, "data") %>% 
  map(., ~ 
    ggplot(.) +
      geom_histogram(
        aes(x = b_slope), 
        color = "blue", 
        fill = "white"
      )
  )
```

### Define management zones based on GWR

```{r yield-response-functions-by-group}

analysis_res <- analysis_res %>% 
  mutate(
    data = list(
      define_mz(
        data = data, 
        max_num_zones = 4, 
        min_obs = 300
      ) 
    )
  )
  
```

```{r }

pluck(analysis_res, "data") %>% 
  map(., ~ 
    tm_shape(.) +
    tm_fill(col = "zone_txt", palette = "Set1") +
    tm_layout_to_add
  )

```

## Yield response function (GAM) estimation by zone

```{r gam-estimate}

analysis_res <- analysis_res %>% 
  mutate(
    gam_res = list(
      gam(
        yield ~ s(input_rate, k = 5, by = zone_txt) 
          + s(X, k = 5) + s(Y, k = 5) 
          + te(X, Y, k = c(5, 5))
        , 
        data = data
      )
    ) 
  ) %>% 
  #=== make the same observations have the same X and Y ===#
  mutate(
    data = list(
      data.table(data) %>% 
        .[, `:=`(
          X = mean(X), 
          Y = mean(Y)
        ), by = "zone_txt"] %>% 
        st_as_sf()
    )
  )

```

## Define grower-chose rate

```{r }

analysis_res <- analysis_res %>% 
  mutate(data = 
    list(
      assign_gc_rate(data, input_type, gc_type, gc_rate)
    )
  )


```

## Profit estimation and economic optimization

### Yield-Profit Estimation (at hypothetical points)

```{r }

analysis_res <- analysis_res %>% 
  mutate(eval_data = 
    list(
      predict_yield_range(
        data = data, 
        est = gam_res, 
        var_name = "input_rate", 
        by = "zone_txt"
      ) %>% 
      .[, type := "opt_v"]%>% 
      .[, .(
        input_rate, zone_txt, type, yield_hat, yield_hat_se
      )]
    )
  ) %>% 
  mutate(
    mean_yield_hat = 
    list(
      eval_data[, .(mean_yield_hat = mean(yield_hat)), by = zone_txt]
    ), 
    mean_yield_actual = 
    list(
      data.table(data)[, 
      .(mean_yield_actual = mean(yield)), 
      by = zone_txt
      ]
    ),
    yield_shift = 
    list(
      mean_yield_actual[mean_yield_hat, on = "zone_txt"] %>% 
        .[, yield_shift :=  mean_yield_actual - mean_yield_hat] %>% 
        .[, .(zone_txt, yield_shift)]
    ),
    gc_rate_data = 
    list(
      data.table(data) %>% 
        unique(by = "zone") %>% 
        .[, input_rate := gc_rate] 
    ),
    eval_data_gc =
    list(
      predict_yield(
        data = gc_rate_data, 
        est = gam_res,
        var_name = "input_rate"
      ) %>% 
      .[, type := "gc"] %>% 
      .[, .(
        input_rate, zone_txt, type, yield_hat, yield_hat_se
      )]
    ),
    eval_data = 
    list(
      rbind(eval_data, eval_data_gc) %>% 
      yield_shift[., on = "zone_txt"] %>% 
      .[, yield_hat := yield_hat + yield_shift] %>% 
      .[, profit_hat := crop_price * yield_hat - price * input_rate] %>% 
      .[, profit_hat_se := crop_price * yield_hat_se] 
    ) 
  ) %>% 
  dplyr::select(
    - mean_yield_hat, - mean_yield_actual, - yield_shift, 
    - gc_rate_data, - eval_data_gc
  )

```

### Yield response functions by zone

```{r }

analysis_res %>% 
  mutate(
    ymin = eval_data[, min(yield_hat - 1.96 * yield_hat_se)] - 10
  ) %>% 
  dplyr::select("data", "eval_data", "ymin") %>% 
  mutate(g_ys = 
    list(
      eval_data %>% 
      filter(type == "opt_v") %>% 
      ggplot(data = .) +
      geom_line(aes(y = yield_hat, x = input_rate)) +
      geom_ribbon(
        aes(
          ymin = yield_hat - 1.96 * yield_hat_se, 
          ymax = yield_hat + 1.96 * yield_hat_se, 
          x = input_rate
        ),
        fill = "red",
        alpha = 0.4
      ) +
      geom_point(data = data, aes(y = yield, x = input_rate)) +
      facet_grid(. ~ zone_txt) +
      ylim(ymin, NA)
    )
  ) %>% 
  pluck("g_ys")

  
```

### Optimal Variable and Uniform Seed Rate

```{r gen-opt-S-v-data-map}

analysis_res <- analysis_res %>% 
  mutate(
    opt_gc_data = list(
      get_opt_gc_data(data, eval_data, gc_type, input_price)
    )
  ) %>% 
  #=== assign optimal variable input rate ===#
  mutate(data = 
    list(
      left_join(
        data, 
        opt_gc_data[type == "opt_v", .(zone_txt, input_rate)] %>% 
          setnames("input_rate", "opt_input"),
        by = "zone_txt"
      )
    )
  ) %>% 
  #=== find the optimal uniform rate ===#
  mutate(data = 
    list(
      mutate(
        data, 
        opt_input_u = find_opt_u(
          data = data, 
          var_name = "input_rate", 
          gam_res = gam_res,
          input_price = price
        )
      )
    )
  )

```

## Statistical testing

### Profit by zone

```{r }
analysis_res <- analysis_res %>% 
  mutate(pi_dif_test_zone =
    list(
      get_pi_dif_test_zone(
        data, 
        gc_type,
        gam_res,
        price 
      )
    )
  )

# data <- analysis_res$data[[1]]
# gc_type <- analysis_res$gc_type[[1]]
# gam_res <- analysis_res$gam_res[[1]]
# input_price <- analysis_res$price[[1]]

```

### Whole-field profit

```{r }

analysis_res <- analysis_res %>% 
  mutate(whole_profits_test = 
    list(
      get_whole_pi_test(data, gam_res, price)
    )
  ) 

```

## Create figures of yield response functions by character

```{r }
# data_sf <- analysis_res$data[[1]]

analysis_res <- analysis_res %>% 
  mutate(ys_by_char = 
    list(
      make_ys_by_chars(data)
    )
  ) 

```

## Save the results

```{r }
analysis_res <- analysis_res %>% 
  select(
    - gam_res
  )

file_name <- here(
  "Reports/Growers", 
  ffy, 
  "analysis_results.rds" 
)

saveRDS(analysis_res, file_name)
```

