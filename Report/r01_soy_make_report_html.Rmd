---
title: "Report on DIFM Field Trial \n field-year-here"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
    number_sections: true
---

<style type="text/css">

body{ /* Normal  */
      font-size: 20px;
  }
td {  /* Table  */
  font-size: 16px;
}
h1.title {
  font-size: 42px;
}
h1 { /* Header 1 */
  font-size: 36px;
}
h2 { /* Header 2 */
    font-size: 28px;
}
h3 { /* Header 3 */
  font-size: 20px;
}
code.r{ /* Code block */
    font-size: 16px;
}
</style>

```{r, cache = F, echo = F, results = "hide"}
library(knitr)
library(here)
knitr::opts_chunk$set(
  cache = TRUE,
  echo = FALSE,
  warning = FALSE,
  cache.lazy = FALSE,
  fig.retina = 6,
  fig.height = 9,
  fig.width = 9,
  message = FALSE
)

```

```{r a02-pacakages, cache = FALSE}
library(sf)
library(ggplot2)
library(tmap)
library(ggcorrplot)
library(patchwork)
library(flextable)
library(officer)
library(parallel)
library(tidyverse)
library(corrplot)
library(data.table)
library(GWmodel)

```

```{r results = "hide"}
#--- working field-year ---#
ffy <- "field-year-here"

#--- root directory ---#
opts_knit$set(root.dir = here("Data", "Growers", ffy))
# setwd(here("Data", ffy))

#--- source functions ---#
list.files(here("Codes/Functions"), full.names = TRUE) %>% 
  .[str_detect(., "functions")] %>% 
  lapply(., function(x) source(x))

#--- make pdf output smaller in size ---#
pdf.options(useDingbats = TRUE)

#--- field parameters ---#
source(
  here("Codes/Functions/unpack_field_parameters.R"),
  local = TRUE
)

#--- currently we do not have this as part of the field parameter data ---#
plot_width <- 60

```

```{r map-layout, cache = TRUE}
tm_layout_to_add <- tm_layout(
  legend.outside = "TRUE",
  frame = FALSE,
  legend.title.size = 1.2,
  legend.text.size = 1
)

```

```{r }
get_seed <- function(c_type, w_zone){
  opt_gc_data[type == c_type & zone_txt == paste0("Zone ", w_zone), seed_rate] %>% round(digits = 0)
}

get_pi <- function(c_type, w_zone){
  opt_gc_data[type == c_type & zone_txt == paste0("Zone ", w_zone), profit_hat] %>% round(digits = 2)
}

get_t_value <- function(w_zone){
  pi_dif_test_zone[zone_txt == paste0("Zone ", w_zone), t] %>% 
    round(digits = 2)
}  

```

```{r data-prep, cache = F, results = "hide"}
#/*----------------------------------*/
#' ## Read in all the analysis results 
#/*----------------------------------*/
results <- readRDS(here("Reports", "Growers", ffy, "analysis_results.rds"))

data_sf <- results$data_sf[[1]]
ys_by_char <- results$ys_by_char[[1]]
eval_data <- results$eval_data[[1]]
opt_gc_data <- results$opt_gc_data[[1]]
pi_data_indiv_sf <- results$pi_data_indiv_sf[[1]]
whole_profits_test <- results$whole_profits_test[[1]]
pi_dif_test_zone <- results$pi_dif_test_zone[[1]]

#/*----------------------------------*/
#' ## Read in datasets for visualization 
#/*----------------------------------*/
analysis_data <- here("Data/Growers", ffy, "Analysis-Ready/analysis_data.rds") %>% 
  readRDS()

trial_design <- here("Data/Growers", ffy, "TrialDesign/trial-design.shp") %>% 
  st_read()

as_applied_s <- readRDS(here("Data/Growers", ffy, "Intermediate/as_applied_s.rds"))

yield_polygons <- readRDS(here("Data/Growers", ffy, "Intermediate/yield_polygons.rds"))

```

# Field Management Information

```{r }
dict_td <- dictionary[type == "trial_design", ]
col_list <- dict_td[, column]

trial_design <- make_var_name_consistent(
  trial_design, 
  dict_td 
)

#--- seed rate conversion ---#
if (any(trial_design$tgt_seed > 10000)){
  #--- convert to K ---#
  trial_design <- mutate(trial_design, tgt_seed = tgt_seed / 1000)
}

```

```{r }
tgts_ls <- unique(trial_design$tgt_seed) 
tgts_ls <- tgts_ls[order(tgts_ls)]

```

+ Baseline seed rate of `r grower_chosen_rate_s` K.
+ Seed target rates: `r paste0(tgts_ls, "K", collapse = ",")` 
+ Planter width: `r planter_width` feet, variable-rate controlled by 15-foot quarter-sections
+ Harvester width: `r harvester_width` feet

# Summary  

A soybean seed rate trial was conducted on the field_name_here field in crop year 2020. The trial was <!--NEED to determine and assign: "was" or "was not". If the trial was not implemented accurately, for now we can write explanations by hand.  But eventually, we could probably write up a list of common reasons why implementation wasn't accurate, and choose one from that list to put in the text.--> implemented with a high level of accuracy. The data and model provide an estimate that, under growing conditions identical to those of the field in 2020, implementing the recommended site-specific seeding rate strategy would have increased profits by \$`r round(whole_profits_test[type_short == "ovg", point_est_dif], digits = 0)` per acre. _statement-whole-field-pi-here_.

# Economic Results and Implications 

```{r optimal-variable-s, fig.cap = "Estimated Optimal site-specific seed rate Rx"}

data_sf %>% 
  mutate(opt_s = round(opt_s)) %>% 
  ggplot(data = .) +
    geom_sf(aes(fill = factor(opt_s)), size = 0.1) +
  scale_fill_brewer(
    palette = "Greens",
    direction = 1,
    name = "Optimal Seed Rate \n (1000 seeds)"
  ) +
  theme_void() +
  theme(
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    legend.position = "bottom"
  )

# st_write(opt_S_sf, dsn = paste0("CLC_Soy_2020 Analyses/Reports/", field_name), layer = "opt_S_map", driver = "ESRI Shapefile", append = FALSE)
```

Figure \@ref(fig:optimal-variable-s) shows the analysis's recommended site-specific seed rate map. The figure was calculated using data from each management zone separately. (Details about how management zones were determined are provided later in this report.)  A generalized additive model (GAM) regression was used to model yield as a function of seed rate in each zone, and then given that model estimation, the profit-maximizing seed rate was found for each zone. Table \@ref(tab:yield-summary-table) lists for each zone the estimated per-acre yields that would have resulted, given the year's growing conditions, from applying the grower-chosen planting strategy and the estimated optimal seed rate derived from the data and model. 

_results-and-discussions-here_

<br>
<br>

```{r yield-summary-table, tab.cap = "Summary yield and seed rate data by zone"}
sum_tab <- copy(opt_gc_data) %>% 
  .[order(zone_txt, type),] %>% 
  .[, .(zone_txt, type, yield_hat, seed_rate)] %>% 
  .[, type := case_when(
    type == "gc" ~ "Grower-chosen",
    type == "opt_v" ~ "Optimal site-specific",
  )] %>% 
  .[, seed_rate := round(seed_rate, digits = 1)] %>% 
  .[, yield_hat := round(yield_hat, digits = 1)] %>% 
  setnames(names(.), c("Zone", "Strategy", "Yield (bu/acre)", "Seed Rate (1000 seeds)")) %>% 
  flextable() %>% 
  hline(
    i = c(2, 4, 6, 8),
    border = fp_border(
      color = "black",
      width = 1
    )
  ) %>% 
  merge_v(
    j = 1
  ) %>% 
  align(
    align = "center",
    part = "all"
  ) %>% 
  fontsize(
    size = 20,
    part = "all"
  ) %>% 
  autofit() %>% 
  fix_border_issues()  

sum_tab

```

<br>
<br>


```{r whole-field-profit-comp, fig.cap = "Confidence intervals of whole-field profit differences, by management strategy"}
ggplot(data = whole_profits_test) +
  geom_errorbar(
    aes(
    ymin = point_est_dif - point_est_dif_se * 1.96, 
    ymax = point_est_dif + point_est_dif_se * 1.96, 
    x = type
    ),
    size = 1.5
  ) +
  geom_point(
    aes(
      y = point_est_dif,
      x = type
    ),
    size = 4,
    color = "red"
  ) +
  geom_hline(yintercept = 0, color = "red", size = 1.5) +
  theme_bw() +
  ylab("Difference in Net Revenue ($/acre)") +
  xlab("") +
  theme(
    axis.title.x = element_text(size = 20, vjust = -1),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    strip.text = element_text(size = 12)
  )

```

# Trial Design and Implementation

Figure \@ref(fig:tgts-yield-ap) displays the trial design and the resultant as-planted map.  Casual observation shows that <!--NEED to determine and assign:  "trial implementation was basically accurate", or "the accuracy of trial implementation was limited by" (add text by hand) -->.  The field's status quo planting plan (that is, the one that would have been used had there been no field trial conducted) was to _grower-plan-here_.  Plots were all `r plot_width` feet wide.  Plot were all between <!--shortest_plot_length_hereK--> and <!--longest_plot_length_hereK-->feet long. A rate of <!--buffer_zone_rate_hereK--> per acre was assigned to a buffer zone around the perimeter of the trial, but observations from the buffer zone were not included as part of the trial in later analysis. Figure \@ref(fig:tgts-yield-ap) pairs the trial's tiral design, as-planted, and yield maps.  No relationship between seed rate and yield is readily detectable with the naked eye. 

```{r trial-design, results = "hide"}
#/*----------------------------------*/
#' ## Trial-design
#/*----------------------------------*/

g_tgts <- ggplot() +
  geom_sf(
    data = trial_design, 
    aes(fill = factor(tgt_seed)),
    size = 0.1
  ) +
  scale_fill_brewer(
    palette = "Greens",
    direction = 1,
    name = "Targeted Seed Rate (1000 seeds)",
    guide = guide_legend(
      ncol = 3
    )
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    legend.key.width =  unit(0.5, "cm"),
    legend.key.height =  unit(0.2, "cm"),
    plot.margin = unit(c(0, 2, 0, 0), "cm") 
  ) 

```

```{r as-planted-seed-map, results = "hide"}
#/*----------------------------------*/
#' ## As-planted Seed Rate
#/*----------------------------------*/
g_ap <- ggplot() +
  geom_sf(
    data = as_applied_s, 
    aes(fill = seed_rate),
    size = 0
  ) +
  scale_fill_distiller(
    palette = "Greens",
    direction = 1,
    name = "As-planted Seed Rate (1000 seeds)"
  ) +
  # guides(color = guide_legend(title.position = "left")) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    legend.key.width =  unit(1, "cm"),
    plot.margin = unit(c(0, 0, 0, 0), "cm")
  ) 

```

```{r gen-raw-yield-map, results = "hide"}
#/*----------------------------------*/
#' ## Raw yield
#/*----------------------------------*/
g_ry <- ggplot() +
  geom_sf(
    data = filter(yield_polygons, flag_bad == 0),
    aes(fill = yield_vol),
    size = 0.2
  ) +
  scale_fill_distiller(
    palette = "YlOrBr",
    direction = 1,
    name = "Yield (bu/acre)"
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    legend.key.width =  unit(1, "cm"),
    plot.margin = unit(c(0, 2, 0, 0), "cm")
  )

```

```{r tgts-yield-ap, fig.cap = "Trial design, as-planted seed rates, and soybean yields, 2020)", fig.height = 15}
g_tgts / g_ap / g_ry 
```

# Overview of Data Processing

The variable-rate planter and yield monitor provided raw as-planted and harvest data. An initial cleaning removed observations with extreme yield or as-planted rates ("outliers") from the raw data. Points were also removed from the headlands, where the data is less reliable due to differences in sun exposure, changes in driving speed, potential application overlaps, etc. The yield points were grouped into polygons using the distance between points, swath width, and the the headings recorded in the raw yield data. Subplots were created by grouping contiguous yield polygons with similar planting and seeding rates into sets of four.  (Subplots were treated as the unit of observation in later analysis.) 

A yield polygon was judged as having a "dominant treatment" when the standard deviation of the yield values at points within the polygon was below a threshold level. Adjacent as-planted polygons were judged as not being in the same group when the difference in application rates surpassed a threshold level.  Polygons without a dominant treatment were not included in the data set used for analysis. This technique also helped eliminate "transition zones, which are areas in which the data show where the harvester and planter did not immediately adjust to new target rates or yield levels when passing from one plot into another. Each subplot's mean as-planted rate and yield were recorded as data. Finally, for each subplot the means of the electrical-conductivity data, SSURGO soil data, and USGS digital elevation data were recorded. In addition the values topographical aspect, slope, curvature, topographical position index and topographical wetness index were calculated from the raw data, and each subplot's means of these values were included in the data used for analysis.  (Formal definitions of these topographical variables are available at <!--citation-->.) Figure \@ref(fig:processed-yield-as-planted) shows maps of the processed yield and as-planted data.  For more detailed explanation of data processing procedures, see <!--We need a cite, and we need to write up the cited document.-->

```{r machine-alignment, fig.cap = "Machinery alignment", eval = F}
include_graphics(machinery_alignment.png))) 
```

```{r gen-yield-seed-map}

g_p_yield <- ggplot(data = analysis_data) +
  geom_sf(
    aes(fill = yield_vol),
    size = 0.2
  ) +
  scale_fill_distiller(
    palette = "YlOrBr",
    direction = 1,
    name = "Yield (bu/acre)"
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    legend.key.width =  unit(1, "cm"),
    plot.margin = unit(c(0, 2, 0, 0), "cm")
  )

g_p_seed <- ggplot(data = analysis_data) +
  geom_sf(
    aes(fill = seed_rate),
    size = 0.2
  ) +
  scale_fill_distiller(
    palette = "YlGn",
    direction = 1,
    name = "Yield (bu/acre)"
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    legend.key.width =  unit(1, "cm"),
    plot.margin = unit(c(0, 2, 0, 0), "cm")
  )

```

```{r  processed-yield-as-planted, echo = F, fig.cap = "Yield and as-planted seed rates", dependson = "save-figures-yield-seed-processed", fig.height = 10}

g_p_yield / g_p_seed
```

# Defining Management Zones Using a Statistical Parameter

Management zones were identified using a statistical model that assumed that, on each site $i$ in the field, yield responds to seed rate to on the following form:

$$
Yield_i = \alpha_i + \beta_i ln(Seed) + v_i.
$$

The $\beta$ parameter is an estimate of the percentage change in yield give a 1% change in seed rate.  A higher $\beta_i$ estimate predicts a higher yield response to seed rate at site $i$, which implies a higher economically optimal seed rate at that site.  Using a statistical technique called geographically weighted regression (GWR), a value of the beta parameter was estimated at each observation point in the field's processed data.  Figure \@ref(fig:map-response) displays the map of the values of $\beta$ on the field.

```{r gen-map-response, fig.cap = "Map of the estimated values of the yield response parameter, $\\beta$"}
g_map_r <- ggplot(data = data_sf) +
  geom_sf(aes(fill = b_slope), size = 0.1) +
  scale_fill_distiller(
    palette = "YlGnBu",
    direction = 1,
    name = expression(beta)
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    legend.key.width =  unit(1, "cm")
  )

g_mz <- ggplot(data_sf) + 
  geom_sf(aes(fill = zone_txt), size = 0.1) +
  scale_fill_discrete(
    name = "",
    guide = guide_legend(nrow = 2)
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20)
  )

```

```{r map-response, echo = F, fig.cap = "Map of the estimated values of the yield response parameter, $\\beta$ the derived management zone" , dependson = "gen-map-response", fig.height = 10}
g_map_r / g_mz
```

```{r ys-by-mz, fig.cap = "(Seed rate, yield) data points for each management zones, and the estimated yield response curves derived from them"}
#--- plot ---#
ggplot() +
  geom_point(
    data = filter(
      data_sf, 
      seed_rate >= min(eval_data$seed_rate),
      seed_rate <= max(eval_data$seed_rate),
    ), 
    aes(y = yield, x = seed_rate),
    size = 0.4
  ) +
  geom_line(
    data = filter(eval_data, type == "opt_v"),
    aes(y = yield_hat, x = seed_rate)
  ) +
  geom_ribbon(
    data = filter(eval_data, type == "opt_v"),
    aes(
      ymin = yield_hat - yield_hat_se * 1.96, 
      ymax = yield_hat + yield_hat_se * 1.96, 
      x = seed_rate
    ),
    fill = "blue",
    alpha = 0.3
  ) +
  facet_grid(. ~ zone_txt) +
  xlab("Seed Rate (1000 seeds)") +
  ylab("Yield (bu/acre)") +
  theme(
    axis.title.x = element_text(size = 16, vjust = -1),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16, angle = 90),
    axis.text.y = element_text(size = 16),
    strip.text = element_text(size = 16)
  )

```

The values of $\beta$ in all of the field's observation points were partitioned into three “zones,” with Zone 1 consisting of the observation points in the lowest third of estimated values of $\beta$, and Zones 2, and 3, containing the observations points from second and third thirds.  The bottom panel of Figure \@ref(fig:map-response) displays those zones.  Figure \@ref(fig:ys-by-mz) shows the zones' (seed rate, yield) scatterplots and estimated yield response curves, which we produced using General Additive Model regression techniques. 

# Exploring Interactions between Seed Rate and Field Characteristics in the Yield Response Function

The discussion thus far has offered statistical evidence of how yield responses and optimal management strategies differed among geographic areas of the field.  But intuitive, agronomy-based explanations have been provided to explain the statistical results.  To investigate why some areas may have higher yield responses than others, it is necessary to examine whether field characteristics interact field characteristics in the yield response function.  Roughly speaking, if a field characteristic interacts with seed rate, it increases the slop of the yield-to-seed response curve.  

Figure \@ref(fig:interaction) illustrates.In figure \@ref(fig:interaction), increasing the value of the field characteristic from $c^{low}$ to $c^{high}$ lowers the slope of the yield response curve.  The characteristic is said to interact negatively with seed rate in affecting yield response.  Note that interaction refers to the slope of the yield response curve, not its height.  Increasing the level of the field characteristic does shift the yield response curve up, but because it also makes the yield response curve flatter, which implies the negative interaction.

```{r interaction, fig.cap = "Increasing the value of a field characteristics lowers the slope of the yield response curve. The characteristic is said to interact negatively with seed rate when affecting yield response", cache = F, fig.height = 5}

gen_yield_chigh <- function(x) {
  80 + 50 * log(x - 20)
}

gen_yield_clow <- function(x) {
  -30 + 90 * log(x - 25)
}

plot_data <- data.table(x = seq(27, 40, length =1000)) %>% 
  .[,y_chigh := gen_yield_chigh(x)] %>% 
  .[,y_clow := gen_yield_clow(x)] %>% 
  melt(id.var = "x") %>% 
  .[, type := case_when(
    variable == "y_chigh" ~ "c_high",
    variable == "y_clow" ~ "c_low"
  )]

g_int <- ggplot(plot_data) +
  geom_line(aes(y = value, x = x, color = type)) +
  labs(x = 'Seed Rate', y ='Yield') +
  geom_hline(yintercept = 27) +
  geom_vline(xintercept = 27) +
  scale_color_manual(
    values = c(
      "c_high" = "#000000", 
      "c_low" = "#C87700"
    )
  ) +
  annotate(
    'text',
    x = 32, y = 218,
    parse = TRUE, 
    label = ('f(seed, c^{high})'),
    color = "#000000",
    size = 6,
    fontface = 3
  ) +
  annotate('text',
    x = 36,
    y = 166,
    parse = TRUE,
    label = 'f(seed, c^{low})',
    color = "#C87700",
    size = 6,
    fontface = 3
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_text(size = 20)
  )

g_int

```

In terms of the model used in this analysis, correlation between the estimated parameter $\beta$ and a field characteristic offers evidence of interaction.  For the field_name_here field, the absolute values of the correlation coefficients were highest for the variables TWI, elevation, and ss_Mp.  TWI stands for topographical wetness index, which describes the tendency of an area of land to accumulate water.  ss_Mp is a variable that indicates whether the data point comes from a location in which the soil is classified as Mobridge-Plankington silt loam.  (All such areas are shaded in figure \@ref(fig:explore-map).)  Figure \@ref(fig:explore-plot) shows how yield response curves differed given different levels of these three interaction terms.  The northeast panel of figure 13 shows that yield is noticeably less responsive to seed rate on the Belmore loam soil than on the rest of the field.  The southwest panel shows the same for the Eakin-Rabin soil.  The northwest panel illustrates that yield tended to respond poorly to seed rates in low-elevation areas.  Interpretation of the northwest panel is a little more complicated;  It seems to show that at on flat soils, when beginning at low rates, an increase in seed reduced yield, but at higher seed rates on flat land, increasing the rate had a strong positive affect on yields.  This difficult-to-interpret result is a reminder that data analysis carries with it inherent uncertainty, and that treating uncertain occurrences as if they were determinate can lead to misleading conclusions 



```{r map-ys-char-11, dependson = "gen-ex-figs", eval = F}
ys_by_char[[2]]
```


```{r map-ys-char-12, dependson = "gen-ex-figs", eval = F}
ys_by_char[[1]]
```
