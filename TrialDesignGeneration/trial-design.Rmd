---
title: "Trial Design Report for field-year-here"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
    number_sections: true
---

<style type="text/css">

body{ /* Normal  */
      font-size: 20px;
  }
td {  /* Table  */
  font-size: 16px;
}
h1.title {
  font-size: 56px;
}
h1 { /* Header 1 */
  font-size: 48px;
}
h2 { /* Header 2 */
    font-size: 36px;
}
h3 { /* Header 3 */
  font-size: 24px;
}
code.r{ /* Code block */
    font-size: 16px;
}
</style>

```{r setup, cache = F, echo = F}
library(knitr)
knitr::opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  error = TRUE,
  warning = FALSE,
  cache.lazy = FALSE,
  message = FALSE,
  fig.width = 12, 
  fig.height = 12
)
```

```{r packages, cache = FALSE}
# === packages ===#
library(exactextractr)
library(sp)
library(sf)
library(here)
library(agricolae)
library(lwgeom)
library(measurements)
library(stringr)
library(tmap)
library(raster)
library(tidyverse)
library(data.table)
```

```{r preparations, cache = F}
#=== source all the functions ===#
source(
  "https://github.com/tmieno2/DIFM/blob/master/Functions/prepare.R?raw=TRUE",
  local = TRUE
)

#--- define field-year ---#
ffy <- "_field-year-here_"  
json_file <- "_json-file-here_"

```

```{r map-layout, cache = TRUE}
tm_layout_to_add <- tm_layout(
  legend.outside = "TRUE",
  frame = FALSE,
  legend.title.size = 2,
  legend.text.size = 1.5
)
```


# Preparation

## Field Parameters

```{r results = "hide"}
trial_data <- get_td_parameters(ffy, json_file)
```   

## Read boundary and ab-line

```{r }
# ffy <- "Wendte_LaueLib80_2020"
# ffy <- "Boeckner_134n_2017"
# ffy <- "Bohnhoff_Adams_2018"
# ffy <- "Holzwart_Holzwart_2021"

#--- field boundary ---#
field_sf <- here("Data", "Growers", ffy, "TrialDesign/boundary.shp") %>% 
  st_read() %>% 
  st_set_4326() %>% 
  st_make_valid() %>%
  st_transform_utm()

#--- ab-line ---#
if (use_ab) {
  ab_line <- here("Data", "Growers", ffy, "TrialDesign/ab-line.shp") %>% 
    #--- read the data ---#
    st_read() %>% 
    st_set_4326() %>% 
    st_make_valid() %>%
    st_transform_utm() 
} else {
  past_aa_input <- "_past-aa-input-file-name-here_" %>% 
  # past_aa_input <- past_aa_input_file %>% 
    #--- read the data ---#
    st_read() %>% 
    st_set_4326() %>% 
    st_make_valid() %>%
    st_transform_utm() 

  ab_line <- get_ab_line(past_aa_input) 
}

```

```{r }
tm_shape(field_sf) +
  tm_borders() +
  tm_shape(ab_line) +
  tm_lines(col = "red")
```


## Option parameters

```{r }
trial_data_rh <- trial_data %>% 
  #=== user-specified list of experimental rates ===#
  mutate(rates = rates) %>% 
  #=== headland length ===#
  # if only one number is supplied, it is applied for both inputs in a two-input case
  mutate(headland_length = conv_unit(head_dist, "ft", "m")) %>% 
  #=== cell height ===#
  mutate(cell_height = conv_unit(10, "ft", "m"))

```

# Create Trial Design

## Make experiment grids

```{r }

#/*----------------------------------*/
#' ## Create experimental plots
#/*----------------------------------*/

num_unique_plot_width <- 
unique(trial_data_rh$input_plot_width) %>% 
length()

if (num_unique_plot_width > 1) {
  trial_data_e <- 
  trial_data_rh %>% 
  mutate(experiment_plots = list(
    make_trial_grids(
      field = field_sf, 
      #--- by default uses the first one ---#
      ab_line = ab_line, 
      plot_width = input_plot_width, 
      cell_height = cell_height,
      headland_length = headland_length
    )  
  ))
} else {

  #=== get the first one of the two if more than one ===#
  trial_data_temp <- trial_data_rh[1, ]

  experiment_plots <-
  make_trial_grids(
    field = field_sf, 
    #--- by default uses the first one ---#
    ab_line = trial_data_temp$ab_line, 
    plot_width = trial_data_temp$input_plot_width, 
    cell_height = cell_height,
    headland_length = trial_data_temp$headland_length
  )  

  trial_data_e <- trial_data_rh %>% 
    mutate(experiment_plots = list(
      experiment_plots
    ))
}

``` 

```{r }
trial_data_eh <-
trial_data_e %>% 
#=== dissolve the experimental plots as a single polygon ===#
mutate(experiment_plots_dissolved = list(
  experiment_plots %>% 
    st_snap_to_grid(size = 0.0001) %>%
    st_make_valid() %>% 
    summarize(plot_id = min(plot_id)) 
)) %>% 
#=== Create headland ===#
mutate(headland = list(
  st_difference(field_sf, experiment_plots_dissolved) %>%
    dplyr::select(geometry) %>% 
    #--- assign grower-chosen rate to the headland ---#
    mutate(rate = gc_rate) 
)) %>% 
mutate(tm_exp_head = list(
  tm_shape(field_sf) +
    tm_borders(col = "black") + 
  tm_shape(headland) +
    tm_fill(
      col = "red", 
      alpha = 0.3, 
      title = "Headland"
    ) +
  tm_shape(experiment_plots) +
    tm_fill(
      col = "strip_id", 
      palette = "Spectral", 
      style = "order"
    )  +
  tm_layout_to_add 
))

```

```{r }
trial_data_e$tm_exp_head

```

## Assigning rates


```{r }

if (!is.na(rates_ls)) {
#/*~~~~~~~~~~~~~~~~~~~~~~*/
#' ### If rates are provided by the user
#/*~~~~~~~~~~~~~~~~~~~~~~*/
  experiment_design <- assign_rates(
    data_sf = experiment_plots, 
    rates_ls = rates_ls,
    # pattern = "block_randomized"
    pattern = "fixed-latin-square"
    # pattern = "sequential"
  )  %>% 
  #--- keep cell_id here for orthogonality check later ---#
  dplyr::select(rate)

  trial_design <- rbind(
    experiment_design,
    headland
  )

} else {

#/*~~~~~~~~~~~~~~~~~~~~~~*/
#' ### If rate are NOT provided by the use
#/*~~~~~~~~~~~~~~~~~~~~~~*/
  trial_designs <- tibble(
    rates = list(
      c(0.5, 0.65, 0.8, 1, 1.15),
      c(0.5, 0.65, 0.8, 1, 1.15, 1.3),
      c(0.6, 0.75, 0.9, 1, 1.2),
      c(0.6, 0.75, 0.9, 1, 1.15, 1.3),
      seq(0.7, 1.2, by = 0.1),
      seq(0.7, 1.3, by = 0.15)   
    )
  ) %>% 
  rowwise() %>% 
  mutate(
    rates = list(
      rates * gc_rate
    )
  ) %>% 
  mutate(
    trial_design = list(
       assign_rates(
        data_sf = experiment_plots, 
        rates_ls = rates
      )  %>% 
      dplyr::select(rate) %>% 
      rbind(., headland)
    ) 
  ) %>% 
  mutate(
    td_map = list(
      tm_shape(trial_design) +
        tm_fill(
          col = "rate", 
          palette = "YlGn", 
          style = "cat"
        ) + 
      tm_shape(headland) +
        tm_borders(
          lwd = 4
        ) +
      tm_shape(ab_line) +
        tm_lines(
          col = "red",
          lwd = 4
        ) +
      tm_layout_to_add
    )
  )

  #--- show the designs ---#
  pluck(trial_designs, "td_map")

}

``` 

# Save the trial design

```{r eval = !is.na(rates_ls), echo = !is.na(rates_ls)}

trial_design_ll <- st_transform(trial_design, 4326)

time_user <- paste0(
  Sys.time(), 
  "-",
  Sys.getenv("USER")
) %>% 
gsub(" ", "-", .) %>% 
gsub("_", "-", .)  

dsn_name <- here("Data", "Growers", ffy, "TrialDesign")

st_write(
  trial_design_ll, 
  dsn = dsn_name,
  layer = paste0("trial-design-", time_user),
  driver = "ESRI Shapefile"
)

writeLines(
  paste0(
    "The trial design was named, trial-design-",
    time_user,
    ".shp"
  )
)
```

# Orthogonality check

Checking if the assigned rates are orthogonal to the soil and field characteristics. 

```{r results = "hide", eval = F}

topo <- file.path(here("Data", "Growers", ffy), "Intermediate/topography.rds") %>% 
  readRDS()

ssurgo <- file.path(here("Data", "Growers", ffy), "Intermediate/ssurgo.rds") %>% 
  readRDS()

topo_values <- topo %>%
  stars_to_stack() %>%
  exact_extract(., st_transform(experiment_design, st_crs(.))) %>%
  rbindlist(idcol = "rowid") %>%
  .[,
    lapply(.SD, weighted.mean, w = coverage_fraction),
    by = rowid,
    .SDcols = paste0("layer.", 1:length(topo))
  ] %>%
  .[, rowid := NULL] %>%
  setnames(names(.), names(topo))

experiment_design <- cbind(experiment_design, topo_values)

ssurgo_values <- dplyr::select(experiment_design, cell_id) %>%
  st_intersection(., ssurgo) %>%
  mutate(area = as.numeric(st_area(.))) %>%
  data.table() %>%
  .[, area_pct := area / sum(area), by = cell_id] %>%
  .[,
    lapply(.SD, weighted.mean, w = area_pct),
    by = cell_id,
    .SDcols = c("clay", "sand", "silt", "water_storage")
  ]

experiment_design <- left_join(experiment_design, ssurgo_values, by = "cell_id")
  
```

```{r eval = F}
#--- plot level ---#
experiment_design %>% 
  dplyr::select(where(is.numeric)) %>% 
  st_drop_geometry() %>% 
  data.table() %>% 
  .[, lapply(.SD, mean), by = .(plot_id, strip_id)] %>% 
  .[,`:=`(
    plot_id = NULL,
    strip_id = NULL
  )] %>% 
  cor() %>% 
  .[, "rate"] 

#--- cell-level ---#
experiment_design %>% 
  dplyr::select(where(is.numeric)) %>% 
  st_drop_geometry() %>% 
  data.table() %>% 
  .[, cell_id := NULL] %>% 
  cor() %>% 
  .[, "rate"] 

```


# Things to do 

+ allow the design to be dependent on spatial variables

## Setting parameters

+ optimal plot width
+ change the plot width in the middle 
