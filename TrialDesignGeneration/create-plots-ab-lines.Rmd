# Preparation for Creating Plots and ab-lines

## Set parameters

```{r }
side_plots_num <- _side-plots-num-here_ 
cell_height <- _cell-height-here_ 
head_dist <- _head-dist-here_
```
## Read boundary and ab-line

```{r }
# ffy <- "Wendte_LaueLib80_2020"
# ffy <- "Boeckner_134n_2017"
# ffy <- "Bohnhoff_Adams_2018"
# ffy <- "Holzwart_Holzwart_2021"


#--- field boundary ---#
field_sf <- here("Data", "Growers", ffy, "TrialDesign/boundary.shp") %>% 
  st_read() %>% 
  #=== assign 4326 when CRS is missing ===#
  st_set_4326() %>% 
  st_make_valid() %>%
  #=== force WGS84 ===#
  # Note: you could have different CRS when field and ab_line 
  # are in different datum without this
  st_transform(4326) %>% 
  st_transform_utm() %>% 
  st_combine()

#--- ab-line ---#
if (use_ab) {
  ab_line <- here("Data", "Growers", ffy, "TrialDesign/ab-line.shp") %>% 
    #--- read the data ---#
    st_read() %>% 
    st_set_4326() %>% 
    st_make_valid() %>%
    #=== force WGS84 ===#
    st_transform(4326) %>% 
    st_transform_utm() 
} else {
  past_aa_input <- "_past-aa-input-file-name-here_" %>% 
  # past_aa_input <- past_aa_input_file %>% 
    #--- read the data ---#
    st_read() %>% 
    st_set_4326() %>% 
    st_make_valid() %>%
    #=== force WGS84 ===#
    st_transform(4326) %>% 
    st_transform_utm() 

  ab_line <- make_ab_line(past_aa_input) 
}

```

```{r }
tm_shape(field_sf) +
  tm_borders() +
  tm_shape(ab_line) +
  tm_lines(col = "red")
```

## Option parameters

```{r }
trial_data_rh <- trial_data %>% 
  #=== headland length ===#
  # if only one number is supplied, it is applied for both inputs in a two-input case
  mutate(headland_length = conv_unit(head_dist, "ft", "m")) %>% 
  #=== cell height ===#
  mutate(cell_height = conv_unit(cell_height, "ft", "m"))

```

# Create Trial Design

## Make experiment grids

```{r }

#/*----------------------------------*/
#' ## Create experimental plots
#/*----------------------------------*/

num_unique_plot_width <- 
unique(trial_data_rh$input_plot_width) %>% 
length()

#=== get the first one of the two if more than one ===#
trial_data_first <- 
trial_data_rh[1, ] %>% 
mutate(line_edge_id = NA) %>% 
rowwise() %>% 
mutate(experiment_plots = list(
  make_trial_grids(
    field = field_sf, 
    #--- by default uses the first one ---#
    # ab_line = trial_data_first$ab_line, 
    ab_line = ab_line[1, ], 
    plot_width = input_plot_width, 
    cell_height = cell_height,
    headland_length = headland_length,
    side_plots_num = side_plots_num
  )
))

if (num_unique_plot_width == 1 & nrow(trial_data_rh) == 1) {

  trial_data_e <- trial_data_first 

} else if(num_unique_plot_width == 1 & nrow(trial_data_rh) == 2) {

  trial_data_second <- 
  trial_data_rh[2, ] %>% 
  mutate(experiment_plots = list(
    trial_data_first$experiment_plots[[1]]
  )) %>% 
  mutate(line_edge_id = NA)

  trial_data_e <- rbind(trial_data_first, trial_data_second)
  # trial_data_e$experiment_plots

} else {

  trial_data_second <- 
  trial_data_rh[2, ] %>% 
  slice(rep(1, 2)) %>% 
  mutate(line_edge_id = 1:2) %>% 
  rowwise() %>% 
  mutate(experiment_plots = list(
    make_trial_grids(
      field = field_sf, 
      #--- by default uses the first one ---#
      ab_line = trial_data_first$experiment_plots[[1]]$line_edges[line_edge_id, ], 
      plot_width = input_plot_width, 
      cell_height = cell_height,
      headland_length = headland_length,
      side_plots_num = side_plots_num,
      second_input = TRUE
    )   
  )) 

  trial_data_e <- rbind(trial_data_first, trial_data_second)

}

``` 

```{r }

trial_data_eh <-
trial_data_e %>% 
rowwise() %>% 
mutate(ab_lines = list(
  experiment_plots$ab_lines %>% 
    st_transform(4326)
)) %>% 
mutate(exp_plots = list(
  experiment_plots$exp_plots
)) %>% 
dplyr::select(- experiment_plots) %>% 
#=== dissolve the experimental plots as a single polygon ===#
mutate(experiment_plots_dissolved = list(
  exp_plots %>% 
    st_snap_to_grid(size = 0.0001) %>%
    st_make_valid() %>% 
    summarize(plot_id = min(plot_id)) 
)) %>% 
#=== Create headland ===#
mutate(headland = list(
  st_difference(field_sf, experiment_plots_dissolved) %>%
    st_as_sf() %>% 
    rename(geometry = x) %>% 
    dplyr::select(geometry)
)) %>% 
mutate(tm_exp_head = list(
  tm_shape(field_sf) +
    tm_borders(col = "black") + 
  tm_shape(headland) +
    tm_fill(
      col = "red", 
      alpha = 0.3, 
      title = "Headland"
    ) +
  tm_shape(exp_plots) +
    tm_fill(
      col = "strip_id", 
      palette = "Spectral", 
      style = "order"
    )  +
  tm_shape(field_sf) +
    tm_borders() +
  tm_layout_to_add 
))

```

```{r }
trial_data_eh$tm_exp_head

```

## Save experiment plots and headland

```{r }
saveRDS(
  trial_data_eh,
  here("Data", "Growers", ffy, "TrialDesign", "exp_plots.rds")
)  
```
