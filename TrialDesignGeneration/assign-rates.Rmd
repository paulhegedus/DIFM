# Assign rates

## Assigning rates

```{r }

num_level_data <- trial_data %>% 
  dplyr::select(form) %>% 
  mutate(num_levels = num_levels) %>% 
  mutate(push = c(FALSE, TRUE))

# trial_data_r$experiment_design
# trial_data_r$headland

# assign_rates(
#       data_sf = trial_data_r$exp_plots[[1]], 
#       rates_ls = trial_data_r$rates[[1]],
#       pattern = "fixed-latin-square"
#     )

#=== user-specified number of levels ===#

trial_data_r <- trial_data_eh %>% 
  left_join(., num_level_data, by = "form") %>% 
  mutate(rates_ls = list(
    get_rates(
      min_rate = min_rate, 
      max_rate = max_rate, 
      gc_rate = gc_rate, 
      num_levels = num_levels
    )
  )) %>% 
  mutate(experiment_design = list(
    assign_rates_latin(
      data_sf = exp_plots,
      rates_ls = rates_ls,
      push = push,
    ) %>% 
    dplyr::select(rate)
  )) %>% 
  mutate(headland = list(
    mutate(headland, rate = gc_rate) %>% 
    dplyr::select(rate)
  )) %>% 
  mutate(trial_design = list(
    rbind(
      experiment_design,
      headland
    ) %>% 
    mutate(rate_tm = rate) %>% 
    setnames(
      "rate",
      case_when(
        form == "seed" ~ "tgts",
        form %in% c("uan28", "uan32", "urea") ~ "tgtn",
        #=== needs to change this ===#
        form == c("potash") ~ "tgtk"
      )
    ) %>% 
    st_transform(4326) 
  )) %>% 
  dplyr::select(
    - exp_plots, - experiment_plots_dissolved,
    - headland, - tm_exp_head, - experiment_design
  )

``` 

# Trial Design Maps

```{r }
trial_data_r %>% 
mutate(map_design = list(
  tm_shape(trial_design) +
    tm_fill(
      col = "rate_tm",
      title = "form"
    )
)) %>% 
pluck("map_design")

```

# Save the trial design

```{r }
time_user <- paste0(
  Sys.time(), 
  "-",
  Sys.getenv("USER")
) %>% 
gsub(" ", "-", .) %>% 
gsub("_", "-", .)  

dsn_name <- here("Data", "Growers", ffy, "TrialDesign")

#=== write the trial design as a shape file ===#
trial_data_r %>% 
summarise(list(
  st_write(
    trial_data_r$trial_design[[1]] %>% dplyr::select(- rate_tm), 
    dsn = dsn_name,
    layer = paste0(
      "trial-design-", form, "-", 
      ifelse(is.na(line_edge_id), "", line_edge_id)
    ),
    driver = "ESRI Shapefile",
    append = FALSE
  )
)) 


#=== write the ab-lines as a shape file ===#
trial_data_r %>% 
summarise(list(
  st_write(
    trial_data_r$ab_lines[[1]], 
    dsn = dsn_name,
    layer = paste0("ab-lines-", form, 
      ifelse(is.na(line_edge_id), "", line_edge_id)
    ),
    driver = "ESRI Shapefile",
    append = FALSE
  )
)) 

```

