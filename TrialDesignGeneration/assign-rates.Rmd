# Assign rates

## Assigning rates

```{r }
num_levels <- _num-levels-here_
design_type <- _design-type-here_ 
max_jumps <- _max-jumps-here_

if (nrow(trial_data) > 1) {
  design_parameter_data <- trial_data %>% 
  dplyr::select(form) %>% 
  mutate(push = c(FALSE, TRUE)) %>% 
  mutate(num_levels = num_levels) %>% 
  mutate(design_type = design_type) %>% 
  mutate(max_jump = max_jumps)  

} else {
  design_parameter_data <- trial_data %>% 
  dplyr::select(form) %>% 
  mutate(push = FALSE) %>% 
  #=== use only the first in case two are provided ===#
  mutate(num_levels = num_levels[1]) %>% 
  mutate(design_type = design_type[1]) %>% 
  mutate(max_jump = max_jumps[1])   
}

#=== user-specified number of levels ===#
trial_data_r <- trial_data_eh %>% 
  left_join(., design_parameter_data, by = "form") %>% 
  mutate(experiment_design = list(
    assign_rates(
      data_sf = exp_plots,
      design_type = "jcl",
      max_jump = max_jump,
      gc_rate = gc_rate,
      min_rate = min_rate,
      max_rate = max_rate,
      num_levels = num_levels, # ignored 
      push = push,
    ) %>% 
    dplyr::select(rate)
  )) %>% 
  mutate(headland = list(
    mutate(headland, rate = gc_rate) %>% 
    dplyr::select(rate)
  )) %>% 
  mutate(input_type = list(
    case_when(
      form == "seed" ~ "S",
      form %in% c("uan28", "uan32", "urea", "NH3") ~ "N",
      #=== needs to change this ===#
      form == c("potash") ~ "K"
    )
  )) %>% 
  mutate(trial_design = list(
    rbind(
      experiment_design,
      headland
    ) %>% 
    #=== only for mapping ===#
    mutate(rate_tm = factor(rate)) %>% 
    setnames(
      "rate",
      case_when(
        form == "seed" ~ "tgts_K",
        form %in% c("uan28", "uan32", "urea") ~ "tgtn",
        #=== needs to change this ===#
        form == c("potash") ~ "tgtk"
      )
    ) %>% 
    st_transform(4326) 
  )) %>% 
  mutate(trial_design = list(
    if ("tgts_K" %in% names(trial_design)) {
      mutate(trial_design, tgts = trial_design$tgts_K * 1000) %>% 
        relocate(tgts_K, tgts)
    } else {
      trial_design
    }
  )) %>% 
  dplyr::select(
    - exp_plots, - experiment_plots_dissolved,
    - headland, - tm_exp_head, - experiment_design
  )

``` 

# Trial Design Maps

```{r }
trial_data_r %>% 
mutate(map_design = list(
  tm_shape(trial_design) +
    tm_fill(
      col = "rate_tm",
      title = form,
      palette = "Greens"
    ) +
  tm_layout_to_add +
  tm_shape(ab_lines) +
    tm_lines(col = "red")
)) %>% 
pluck("map_design")

```

# Save the trial design

```{r }
# time_user <- paste0(
#   Sys.time(), 
#   "-",
#   Sys.getenv("USER")
# ) %>% 
# gsub(" ", "-", .) %>% 
# gsub("_", "-", .)  

dsn_name <- here("Data", "Growers", ffy, "TrialDesign")

#=== write the trial design as a shape file ===#
trial_data_r %>% 
summarise(list(
  st_write(
    trial_data_r$trial_design[[1]] %>% dplyr::select(- rate_tm), 
    dsn = dsn_name,
    layer = paste0(
      "trial-design-", tolower(input_type), 
      ifelse(is.na(line_edge_id), "", line_edge_id)
    ),
    driver = "ESRI Shapefile",
    append = FALSE
  )
)) 


#=== write the ab-lines as a shape file ===#
trial_data_r %>% 
summarise(list(
  st_write(
    trial_data_r$ab_lines[[1]], 
    dsn = dsn_name,
    layer = paste0("ab-lines-", tolower(input_type), 
      ifelse(is.na(line_edge_id), "", line_edge_id)
    ),
    driver = "ESRI Shapefile",
    append = FALSE
  )
)) 

```

